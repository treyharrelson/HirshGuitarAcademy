<body>
    <div class="top-bar">
        <h1>
            My Forum
        </h1>
    </div>
    <div class="main">
        <ol id = 'post-container'>
        </ol>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get current page from URL (e.g., index.html?page=2), default to 1
            const urlParams = new URLSearchParams(window.location.search);
            const currentPage = parseInt(urlParams.get('page')) || 1;
            
            fetchPosts(currentPage);
        });

        async function fetchPosts(page) {
            try {
                // Call the API we made in app.js
                const response = await fetch(`/api/posts?page=${page}`);
                const data = await response.json();

                renderPosts(data.posts);
                renderPagination(data.totalPages, data.currentPage);
            } catch (err) {
                console.error("Failed to load posts", err);
            }
        }

        function renderPosts(posts) {
            const container = document.getElementById('post-container');
            container.innerHTML = ''; // Clear "Loading..." text

            posts.forEach(post => {
                // Note: If your API doesn't return comments array, 
                // this check prevents the page from crashing.
                const commentCount = post.comments ? post.comments.length : 0;
                
                const html = `
                <li class="row">
                    <a href="/thread.html?${post.id}">
                        <h4 class="title">${post.title}</h4>
                        <div class="bottom">
                            <p class="timestamp">
                                ${new Date(post.datePosted).toLocaleString()}
                            </p>
                            <p class="comment-count">
                                ${commentCount} comments
                            </p>
                        </div>           
                    </a>
                </li>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderPagination(totalPages, currentPage) {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';
            
            // Helper to create a button
            const createButton = (page, text = page, isActive = false) => {
                const btn = document.createElement('a');
                btn.className = isActive ? 'page-btn active' : 'page-btn';
                btn.innerText = text;
                // Clicking reload the page with new query param
                btn.href = `?page=${page}`; 
                return btn;
            };

            // Helper for "..." text
            const createEllipsis = () => {
                const span = document.createElement('span');
                span.innerText = '...';
                span.style.padding = '5px';
                return span;
            };

            // LOGIC: "1, 2, 3 ... 100, 101"
            // We always show the First page, Last page, and neighbors of Current.
            
            const range = 2; // How many numbers to show around current page

            // Always show Page 1
            paginationDiv.appendChild(createButton(1, 1, currentPage === 1));

            // Logic to determine if we need a "..." after 1
            if (currentPage - range > 2) {
                paginationDiv.appendChild(createEllipsis());
            }

            // Middle pages (Neighbors)
            for (let i = Math.max(2, currentPage - range); i <= Math.min(totalPages - 1, currentPage + range); i++) {
                paginationDiv.appendChild(createButton(i, i, currentPage === i));
            }

            // Logic to determine if we need a "..." before the last page
            if (currentPage + range < totalPages - 1) {
                paginationDiv.appendChild(createEllipsis());
            }

            // Always show Last Page (if more than 1 page exists)
            if (totalPages > 1) {
                paginationDiv.appendChild(createButton(totalPages, totalPages, currentPage === totalPages));
            }
        }
    </script>
    <style>
        body {
            margin: 10px 60px;
        }
        a {
            text-decoration: none;
            color: black;
        }
        h1, h4, ol {
            margin: 0;
        }
        p {
            margin: 5px 0;
        }
        .top-bar {
            background-color: skyblue;
            padding: 0 40px;
        }
        .main {
            background-color: #F6F6Ef;
            padding: 10px 15px; 
        }
        .row {
            padding: 5px 0;
        }
        .bottom {
            display: flex;
            color: grey;
            font-size: 12px;
        }
        .timestamp {
            padding-right: 10px;
        }
    </style>
</body>

